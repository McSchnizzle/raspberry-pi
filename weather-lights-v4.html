<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=800, height=480, initial-scale=1.0, user-scalable=no">
<title>Portland Weather v4</title>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
  :root{
    --fg:rgba(255,255,255,0.93);--fg-dim:rgba(255,255,255,0.50);--fg-muted:rgba(255,255,255,0.26);
    --glass:rgba(255,255,255,0.06);--glass-hi:rgba(255,255,255,0.10);--glass-border:rgba(255,255,255,0.09);
    --accent:#f5c842;--accent-glow:rgba(245,200,66,0.25);
  }
  html,body{width:800px;height:480px;overflow:hidden;font-family:-apple-system,'Segoe UI','Helvetica Neue',sans-serif;color:var(--fg);-webkit-user-select:none;user-select:none;-webkit-font-smoothing:antialiased;}
  body{background:#0a101c;position:relative;}

  /* Screen-off blackout overlay */
  #screenBlackout{position:fixed;inset:0;z-index:9999;background:#000;display:none;pointer-events:all;}

  #webcamBg{position:absolute;top:0;left:0;width:540px;height:480px;z-index:0;overflow:hidden;pointer-events:none;background:#0a101c;}
  #webcamBg img{width:100%;height:100%;object-fit:cover;opacity:0.75;filter:brightness(0.7) saturate(0.85);}
  #sceneCanvas{position:absolute;top:0;left:0;width:540px;height:480px;z-index:1;pointer-events:none;}

  body::after{content:'';position:fixed;inset:0;opacity:0.018;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");pointer-events:none;z-index:200;}

  .layout{position:relative;z-index:1;width:800px;height:480px;display:grid;grid-template-columns:540px 260px;transition:transform 0.5s ease;}

  /* Burn-in layout variants */
  body.layout-mirror .layout{direction:rtl;}
  body.layout-mirror .layout > *{direction:ltr;}
  body.layout-mirror #webcamBg{left:auto;right:0;}
  body.layout-mirror #sceneCanvas{left:auto;right:0;}
  body.layout-shift-dr .layout{transform:translate(10px,10px);}
  body.layout-shift-ul .layout{transform:translate(-8px,-8px);}

  .weather-panel{position:relative;padding:14px 20px 18px;display:flex;flex-direction:column;overflow:hidden;}
  .weather-top{display:flex;justify-content:space-between;align-items:baseline;position:relative;z-index:5;}
  .location{font-size:11px;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;color:var(--fg-dim);}
  .sensor-badge{font-size:7px;font-weight:700;letter-spacing:0.1em;color:#82e0aa;background:rgba(130,224,170,0.12);border:1px solid rgba(130,224,170,0.25);padding:1px 5px;border-radius:3px;margin-left:6px;vertical-align:middle;}
  .clock-area{text-align:right;}
  .time{font-size:26px;font-weight:200;letter-spacing:0.02em;color:var(--fg);font-variant-numeric:tabular-nums;}
  .date{font-size:9px;color:var(--fg-muted);margin-top:1px;letter-spacing:0.06em;}

  .weather-main{display:flex;align-items:center;gap:14px;position:relative;z-index:5;margin-top:6px;}
  .weather-icon{font-size:50px;line-height:1;filter:drop-shadow(0 4px 16px rgba(0,0,0,0.4));animation:float 7s ease-in-out infinite;}
  @keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}
  .temp-block{display:flex;align-items:flex-start;line-height:1;}
  .temp-value{font-size:72px;font-weight:200;letter-spacing:-0.04em;line-height:0.85;background:linear-gradient(180deg,var(--fg) 40%,var(--fg-dim) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .temp-unit{font-size:18px;font-weight:200;color:var(--fg-muted);margin-top:8px;}
  .weather-details{display:flex;flex-direction:column;gap:2px;margin-left:6px;}
  .condition-text{font-size:13px;font-weight:400;color:var(--fg-dim);letter-spacing:0.02em;}
  .feels-like{font-size:10px;color:var(--fg-muted);}

  .stats-row{display:flex;gap:8px;margin-top:10px;position:relative;z-index:5;}
  .stat-card{flex:1;padding:8px 4px;border-radius:10px;background:rgba(0,0,0,0.35);backdrop-filter:blur(8px);border:1px solid var(--glass-border);text-align:center;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;}
  .stat-card:active{transform:scale(0.96);background:rgba(0,0,0,0.5);}
  .stat-label{font-size:8px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--fg-muted);margin-bottom:3px;}
  .stat-value{font-size:26px;font-weight:300;color:var(--fg);font-variant-numeric:tabular-nums;}
  .stat-unit{font-size:10px;color:var(--fg-muted);}
  .stat-sub{font-size:9px;color:var(--fg-muted);margin-top:1px;}

  .wind-compass{position:relative;width:40px;height:40px;margin:0 auto 1px;}
  .compass-ring{position:absolute;inset:0;border-radius:50%;border:1px solid var(--glass-border);}
  .compass-arrow{position:absolute;top:50%;left:50%;width:2px;height:17px;background:linear-gradient(to top,transparent 0%,var(--accent) 100%);transform-origin:bottom center;border-radius:1px;transition:transform 1s ease;}
  .compass-dot{position:absolute;top:50%;left:50%;width:3px;height:3px;background:var(--accent);border-radius:50%;transform:translate(-50%,-50%);}
  .compass-n{position:absolute;top:1px;left:50%;transform:translateX(-50%);font-size:6px;font-weight:700;color:var(--fg-muted);}

  .pressure-bar{width:100%;height:3px;background:rgba(255,255,255,0.06);border-radius:2px;margin-top:4px;overflow:hidden;position:relative;}
  .pressure-fill{height:100%;border-radius:2px;transition:width 1s ease;background:linear-gradient(90deg,#4a9eff,#82e0aa,#f5c842,#ff6b6b);}
  .pressure-marker{position:absolute;top:-2px;width:2px;height:7px;background:white;border-radius:1px;transition:left 1s ease;}

  .forecast-row{display:flex;gap:8px;margin-top:auto;padding-top:8px;margin-bottom:16px;border-top:1px solid var(--glass-border);position:relative;z-index:5;overflow:hidden;}
  .fc-day{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;padding:12px 6px 10px;border-radius:10px;background:rgba(0,0,0,0.32);backdrop-filter:blur(4px);border:1px solid transparent;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;overflow:hidden;}
  .fc-day:active{transform:scale(0.96);background:rgba(0,0,0,0.45);}
  .fc-day.today{border-color:var(--glass-border);background:rgba(0,0,0,0.42);}
  .fc-name{font-size:14px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--fg-muted);}
  .fc-icon{font-size:40px;line-height:1;}
  .fc-temps{display:flex;gap:5px;align-items:baseline;}
  .fc-hi{font-size:26px;font-weight:500;color:var(--fg);}
  .fc-lo{font-size:20px;font-weight:300;color:var(--fg-muted);}
  .fc-rain{font-size:12px;color:rgba(100,180,255,0.7);}

  /* === LIGHTS PANEL === */
  .lights-panel{padding:10px 10px 8px;display:flex;flex-direction:column;gap:6px;background:rgba(0,0,0,0.2);border-left:1px solid var(--glass-border);overflow-y:auto;-webkit-overflow-scrolling:touch;}
  .lights-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;}
  .lights-title{font-size:10px;font-weight:600;letter-spacing:0.14em;text-transform:uppercase;color:var(--fg-muted);}
  .lights-allbtns{display:flex;gap:5px;}
  .lights-allbtn{padding:5px 12px;border-radius:6px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg-dim);font-size:11px;font-weight:600;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;}
  .lights-allbtn:active{background:var(--glass-hi);transform:scale(0.95);}

  .light-card{display:flex;flex-direction:column;gap:6px;padding:10px 12px;border-radius:10px;background:rgba(0,0,0,0.35);backdrop-filter:blur(8px);border:1px solid var(--glass-border);transition:all 0.25s;}
  .light-card.on{border-color:rgba(245,200,66,0.25);background:rgba(245,200,66,0.05);}
  .light-top{display:flex;align-items:center;gap:8px;}
  .light-info{flex-shrink:0;min-width:52px;}
  .light-name{font-size:12px;font-weight:600;color:var(--fg-dim);line-height:1.2;}
  .light-pct{font-size:16px;font-weight:700;color:var(--fg-muted);font-variant-numeric:tabular-nums;transition:color 0.25s;}
  .light-card.on .light-pct{color:var(--accent);}
  .light-slider{flex:1;height:32px;position:relative;display:flex;align-items:center;cursor:pointer;touch-action:none;-webkit-tap-highlight-color:transparent;}
  .slider-bg{position:absolute;left:0;top:50%;transform:translateY(-50%);width:100%;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;}
  .slider-fill{height:100%;background:var(--accent);border-radius:3px;transition:width 0.08s;}
  .slider-thumb{position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 5px rgba(0,0,0,0.4);top:50%;transform:translate(-50%,-50%);pointer-events:none;transition:left 0.08s;}
  .toggle-btn{width:38px;height:22px;border-radius:11px;border:none;background:rgba(255,255,255,0.1);position:relative;cursor:pointer;flex-shrink:0;transition:background 0.25s;-webkit-tap-highlight-color:transparent;}
  .toggle-btn.on{background:var(--accent);}
  .toggle-btn::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.3);}
  .toggle-btn.on::after{transform:translateX(16px);}

  .color-swatches{display:flex;gap:4px;padding:2px 0 0 0;flex-wrap:wrap;}
  .color-swatch{width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,0.15);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;flex-shrink:0;}
  .color-swatch:active{transform:scale(0.85);}
  .color-swatch.active{border-color:var(--fg);box-shadow:0 0 8px rgba(255,255,255,0.3);}

  /* Star lights card */
  .star-card{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:10px;background:rgba(0,0,0,0.35);backdrop-filter:blur(8px);border:1px solid var(--glass-border);transition:all 0.25s;cursor:pointer;-webkit-tap-highlight-color:transparent;}
  .star-card.on{border-color:rgba(245,200,66,0.25);background:rgba(245,200,66,0.05);}
  .star-card:active{transform:scale(0.97);}
  .star-card-left{display:flex;align-items:center;gap:8px;}
  .star-card-icon{font-size:20px;line-height:1;}
  .star-card-name{font-size:13px;font-weight:600;color:var(--fg-dim);}
  .star-card-status{font-size:13px;font-weight:700;color:var(--fg-muted);transition:color 0.25s;}
  .star-card.on .star-card-status{color:var(--accent);}

  /* === SPORTS SCORES === */
  .sports-section{margin-top:auto;padding-top:5px;border-top:1px solid var(--glass-border);display:flex;flex-direction:column;gap:4px;}
  .sports-header{font-size:8px;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;color:var(--fg-muted);margin-bottom:1px;}
  .game-card{display:flex;flex-direction:column;gap:2px;padding:5px 7px;border-radius:7px;background:rgba(0,0,0,0.30);border:1px solid var(--glass-border);}
  .game-card.live{border-color:rgba(255,60,60,0.3);background:rgba(255,60,60,0.04);}
  .game-league{font-size:9px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--fg-muted);}
  .game-row{display:flex;justify-content:space-between;align-items:center;}
  .game-team{font-size:14px;font-weight:600;color:var(--fg-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:140px;}
  .game-score{font-size:17px;font-weight:700;color:var(--fg);font-variant-numeric:tabular-nums;min-width:28px;text-align:right;}
  .game-status{font-size:10px;color:var(--fg-muted);text-align:center;margin-top:1px;}
  .game-status.live-text{color:rgba(255,80,80,0.9);font-weight:600;}
  .game-card{cursor:pointer;-webkit-tap-highlight-color:transparent;transition:background 0.15s;}
  .game-card:active{background:rgba(255,255,255,0.06);}

  /* Game detail overlay */
  .game-detail-overlay .overlay-content{width:560px;max-height:350px;padding:18px 22px;}
  .gd-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .gd-league{font-size:9px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent);}
  .gd-status{font-size:10px;color:var(--fg-muted);}
  .gd-status.live{color:rgba(255,80,80,0.9);font-weight:600;}
  .gd-teams{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
  .gd-team-row{display:flex;align-items:center;gap:10px;}
  .gd-team-logo{width:32px;height:32px;border-radius:4px;background:rgba(255,255,255,0.05);object-fit:contain;}
  .gd-team-name{font-size:14px;font-weight:500;color:var(--fg);flex:1;}
  .gd-team-record{font-size:10px;color:var(--fg-muted);margin-left:4px;}
  .gd-team-score{font-size:22px;font-weight:700;color:var(--fg);font-variant-numeric:tabular-nums;min-width:36px;text-align:right;}
  .gd-info{display:flex;flex-direction:column;gap:5px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.06);}
  .gd-info-row{display:flex;justify-content:space-between;align-items:center;}
  .gd-info-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--fg-muted);}
  .gd-info-val{font-size:11px;color:var(--fg-dim);}

  .version-tag{position:absolute;bottom:3px;left:8px;font-size:8px;color:rgba(255,255,255,0.35);letter-spacing:0.06em;z-index:10;pointer-events:none;}
  .cam-stamp{position:absolute;bottom:3px;left:50px;font-size:8px;color:rgba(255,255,255,0.35);letter-spacing:0.04em;z-index:10;pointer-events:none;}

  /* === OVERLAY / MODAL === */
  .overlay{position:fixed;inset:0;z-index:500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);-webkit-tap-highlight-color:transparent;}
  .overlay.show{display:flex;}
  .overlay-content{width:720px;max-height:420px;background:rgba(12,18,32,0.96);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:20px 24px;box-shadow:0 20px 60px rgba(0,0,0,0.6);position:relative;}
  .overlay-title{font-size:14px;font-weight:600;color:var(--fg-dim);letter-spacing:0.06em;margin-bottom:12px;}
  .overlay-close-hint{position:absolute;top:10px;right:16px;font-size:8px;color:var(--fg-muted);letter-spacing:0.1em;text-transform:uppercase;}
  .chart-canvas{display:block;width:100%;border-radius:8px;}

  /* Forecast detail overlay */
  .fc-detail-overlay .overlay-content{width:720px;max-height:430px;padding:16px 20px;}
  .fc-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px 20px;margin-top:10px;}
  .fc-detail-left{display:flex;flex-direction:column;gap:8px;}
  .fc-detail-right{display:flex;flex-direction:column;gap:6px;}
  .fc-detail-temps{display:flex;align-items:baseline;gap:12px;}
  .fc-detail-hi{font-size:36px;font-weight:200;color:var(--fg);}
  .fc-detail-lo{font-size:22px;font-weight:200;color:var(--fg-muted);}
  .fc-detail-condition{font-size:14px;color:var(--fg-dim);display:flex;align-items:center;gap:8px;}
  .fc-detail-stat{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
  .fc-detail-stat-label{font-size:10px;color:var(--fg-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.08em;}
  .fc-detail-stat-val{font-size:12px;color:var(--fg);}

  /* === LAYOUT TABS === */
  .layout-tabs{display:flex;gap:3px;position:relative;z-index:5;margin:4px 0 2px;}
  .layout-tab{padding:3px 10px;border-radius:4px;border:1px solid var(--glass-border);background:var(--glass);color:var(--fg-muted);font-size:8px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.2s;font-family:inherit;}
  .layout-tab:active{transform:scale(0.95);}
  .layout-tab.active{background:rgba(245,200,66,0.1);border-color:rgba(245,200,66,0.25);color:var(--accent);}
  .weather-view{display:none;flex-direction:column;flex:1;overflow:hidden;}
  .weather-view.active{display:flex;}

  /* === VIEW 2: COCKPIT === */
  .v2-header{display:flex;align-items:center;gap:10px;margin-top:4px;}
  .v2-icon{font-size:36px;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3));}
  .v2-temp{font-family:'Chakra Petch','Courier New',monospace;font-size:44px;font-weight:300;letter-spacing:-0.03em;color:var(--fg);line-height:1;}
  .v2-temp-unit{font-family:'Chakra Petch',monospace;font-size:16px;font-weight:300;color:var(--fg-muted);}
  .v2-cond{font-family:'Chakra Petch',monospace;font-size:11px;color:var(--fg-dim);letter-spacing:0.03em;}
  .v2-feels{font-family:'Chakra Petch',monospace;font-size:9px;color:var(--fg-muted);}
  .v2-gauges{display:flex;justify-content:center;gap:8px;margin-top:6px;}
  .gauge{position:relative;width:110px;height:110px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;}
  .gauge:active{transform:scale(0.95);}
  .gauge svg{width:110px;height:110px;position:absolute;top:0;left:0;}
  .gauge-bg{fill:none;stroke:rgba(255,255,255,0.07);stroke-width:7;stroke-dasharray:235.6 78.5;stroke-linecap:round;transform:rotate(135deg);transform-origin:60px 60px;}
  .gauge-arc{fill:none;stroke-width:7;stroke-dasharray:0 314.16;stroke-linecap:round;transform:rotate(135deg);transform-origin:60px 60px;transition:stroke-dasharray 1.2s ease,stroke 0.5s ease;}
  .gauge-center{position:relative;z-index:2;text-align:center;pointer-events:none;}
  .gauge-val{font-family:'Chakra Petch',monospace;font-size:20px;font-weight:600;color:var(--fg);}
  .gauge-unit{font-family:'Chakra Petch',monospace;font-size:8px;color:var(--fg-muted);margin-top:-2px;}
  .gauge-name{position:absolute;bottom:6px;left:0;right:0;text-align:center;font-family:'Chakra Petch',monospace;font-size:7px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--fg-muted);pointer-events:none;}
  .v2-extras{display:flex;justify-content:center;gap:18px;margin-top:4px;font-family:'Chakra Petch',monospace;}
  .v2-extra{text-align:center;cursor:pointer;-webkit-tap-highlight-color:transparent;}
  .v2-extra:active{opacity:0.7;}
  .v2-extra-label{font-size:7px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--fg-muted);}
  .v2-extra-val{font-size:15px;font-weight:600;color:var(--fg);}
  .v2-extra-sub{font-size:8px;color:var(--fg-muted);}
  .v2-forecast{display:flex;gap:6px;margin-top:auto;padding-top:6px;border-top:1px solid var(--glass-border);margin-bottom:16px;}
  .v2-fc{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px;border-radius:8px;background:rgba(0,0,0,0.3);border:1px solid transparent;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;font-family:'Chakra Petch',monospace;}
  .v2-fc:active{transform:scale(0.96);}
  .v2-fc.today{border-color:var(--glass-border);background:rgba(0,0,0,0.4);}
  .v2-fc-name{font-size:10px;font-weight:700;color:var(--fg-muted);letter-spacing:0.08em;text-transform:uppercase;}
  .v2-fc-icon{font-size:26px;line-height:1;}
  .v2-fc-temps{font-size:13px;font-weight:600;}
  .v2-fc-hi{color:var(--fg);}
  .v2-fc-lo{color:var(--fg-muted);font-weight:300;}

  /* === VIEW 3: HORIZON === */
  .v3-center{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;}
  .v3-icon{font-size:38px;margin-bottom:0;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.4));}
  .v3-temp-row{display:flex;align-items:flex-start;line-height:1;}
  .v3-temp{font-family:'Cormorant Garamond',Georgia,serif;font-size:108px;font-weight:300;letter-spacing:-0.04em;background:linear-gradient(180deg,rgba(255,255,255,0.95) 30%,rgba(255,255,255,0.45) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:0.85;}
  .v3-unit{font-family:'Cormorant Garamond',Georgia,serif;font-size:28px;font-weight:300;color:var(--fg-muted);margin-top:12px;}
  .v3-cond{font-size:14px;color:var(--fg-dim);margin-top:4px;letter-spacing:0.04em;}
  .v3-feels{font-size:10px;color:var(--fg-muted);margin-top:1px;}
  .v3-stats{display:flex;justify-content:center;margin-top:10px;border-top:1px solid rgba(255,255,255,0.06);border-bottom:1px solid rgba(255,255,255,0.06);padding:6px 0;}
  .v3-stat{padding:0 12px;border-right:1px solid rgba(255,255,255,0.06);text-align:center;cursor:pointer;-webkit-tap-highlight-color:transparent;}
  .v3-stat:last-child{border-right:none;}
  .v3-stat:active{opacity:0.6;}
  .v3-stat-val{font-size:14px;font-weight:500;color:var(--fg);}
  .v3-stat-label{font-size:7px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--fg-muted);margin-top:1px;}
  .v3-forecast{display:flex;gap:8px;margin-top:auto;padding-top:8px;margin-bottom:16px;}
  .v3-fc{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;border-radius:10px;background:rgba(0,0,0,0.3);border:1px solid transparent;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;}
  .v3-fc:active{transform:scale(0.96);}
  .v3-fc.today{border-color:var(--glass-border);background:rgba(0,0,0,0.4);}
  .v3-fc-name{font-size:12px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--fg-muted);}
  .v3-fc-icon{font-size:32px;line-height:1;}
  .v3-fc-temps{display:flex;gap:4px;align-items:baseline;}
  .v3-fc-hi{font-size:20px;font-weight:500;color:var(--fg);}
  .v3-fc-lo{font-size:14px;font-weight:300;color:var(--fg-muted);}

  /* === VIEW 4: GRID === */
  .v4-header{display:flex;align-items:center;gap:8px;margin-top:4px;}
  .v4-icon{font-size:30px;}
  .v4-temp{font-size:34px;font-weight:200;color:var(--fg);letter-spacing:-0.03em;line-height:1;}
  .v4-meta{display:flex;flex-direction:column;gap:1px;margin-left:4px;}
  .v4-cond{font-size:11px;color:var(--fg-dim);}
  .v4-feels{font-size:9px;color:var(--fg-muted);}
  .data-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-top:6px;}
  .data-cell{padding:7px 5px;border-radius:7px;background:rgba(0,0,0,0.35);border:1px solid var(--glass-border);border-left:3px solid var(--accent);text-align:center;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;}
  .data-cell:active{transform:scale(0.96);background:rgba(0,0,0,0.5);}
  .data-cell-label{font-size:7px;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--fg-muted);margin-bottom:2px;}
  .data-cell-val{font-size:20px;font-weight:300;color:var(--fg);font-variant-numeric:tabular-nums;line-height:1.1;}
  .data-cell-unit{font-size:8px;color:var(--fg-muted);}
  .data-cell-sub{font-size:8px;color:var(--fg-muted);margin-top:1px;}
  .dc-wind{border-left-color:#64b4ff;}
  .dc-pres{border-left-color:#82e0aa;}
  .dc-hum{border-left-color:#7ec8e3;}
  .dc-uv{border-left-color:#f5c842;}
  .dc-precip{border-left-color:#6ab4ff;}
  .dc-dew{border-left-color:#a78bfa;}
  .v4-forecast{display:flex;gap:5px;margin-top:auto;padding-top:6px;border-top:1px solid var(--glass-border);margin-bottom:16px;}
  .v4-fc{flex:1;display:flex;align-items:center;gap:5px;padding:6px 6px;border-radius:7px;background:rgba(0,0,0,0.3);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.15s;}
  .v4-fc:active{transform:scale(0.96);}
  .v4-fc-icon{font-size:22px;line-height:1;}
  .v4-fc-info{display:flex;flex-direction:column;min-width:0;}
  .v4-fc-name{font-size:8px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:var(--fg-muted);}
  .v4-fc-temps{font-size:12px;color:var(--fg);white-space:nowrap;}
  .v4-fc-lo{color:var(--fg-muted);font-weight:300;}
</style>
</head>
<body>

<div id="screenBlackout"></div>

<div id="webcamBg">
  <img id="webcamImg" src="" alt="">
</div>
<canvas id="sceneCanvas" width="1080" height="960"></canvas>

<div class="overlay" id="statOverlay">
  <div class="overlay-content">
    <div class="overlay-title" id="statOverlayTitle">24-Hour History</div>
    <div class="overlay-close-hint">Tap to dismiss</div>
    <canvas class="chart-canvas" id="statChart" width="1344" height="560"></canvas>
  </div>
</div>

<div class="overlay fc-detail-overlay" id="fcOverlay">
  <div class="overlay-content">
    <div class="overlay-title" id="fcOverlayTitle">Forecast Detail</div>
    <div class="overlay-close-hint">Tap to dismiss</div>
    <div class="fc-detail-grid">
      <div class="fc-detail-left">
        <div class="fc-detail-temps">
          <span class="fc-detail-hi" id="fcHi">--</span>
          <span class="fc-detail-lo" id="fcLo">--</span>
        </div>
        <div class="fc-detail-condition" id="fcCondition"></div>
        <canvas class="chart-canvas" id="fcChart" width="660" height="320"></canvas>
      </div>
      <div class="fc-detail-right" id="fcStats"></div>
    </div>
  </div>
</div>

<div class="overlay game-detail-overlay" id="gameOverlay">
  <div class="overlay-content">
    <div class="overlay-close-hint">Tap to dismiss</div>
    <div class="gd-header">
      <span class="gd-league" id="gdLeague"></span>
      <span class="gd-status" id="gdStatus"></span>
    </div>
    <div class="gd-teams">
      <div class="gd-team-row">
        <img class="gd-team-logo" id="gdAwayLogo" src="" alt="">
        <span class="gd-team-name" id="gdAwayName"></span>
        <span class="gd-team-record" id="gdAwayRecord"></span>
        <span class="gd-team-score" id="gdAwayScore"></span>
      </div>
      <div class="gd-team-row">
        <img class="gd-team-logo" id="gdHomeLogo" src="" alt="">
        <span class="gd-team-name" id="gdHomeName"></span>
        <span class="gd-team-record" id="gdHomeRecord"></span>
        <span class="gd-team-score" id="gdHomeScore"></span>
      </div>
    </div>
    <div class="gd-info" id="gdInfo"></div>
  </div>
</div>

<div class="layout">
  <div class="weather-panel">
    <div class="version-tag">v4.2</div>
    <div class="cam-stamp" id="camStamp"></div>
    <div class="weather-top">
      <div class="location" id="location">Portland, OR</div><span class="sensor-badge" id="sensorBadge" style="display:none">LIVE</span>
      <div class="clock-area">
        <div class="time" id="time"></div>
        <div class="date" id="date"></div>
      </div>
    </div>

    <div class="layout-tabs">
      <button class="layout-tab active" data-view="1">Classic</button>
      <button class="layout-tab" data-view="2">Cockpit</button>
      <button class="layout-tab" data-view="3">Horizon</button>
      <button class="layout-tab" data-view="4">Grid</button>
      <button class="layout-tab" id="refresh-btn" style="margin-left:auto;" onclick="location.reload()">Refresh</button>
    </div>

    <div class="weather-view active" id="view1">
    <div class="weather-main">
      <div class="weather-icon" id="weatherIcon">--</div>
      <div class="temp-block">
        <span class="temp-value" id="temp">&mdash;</span>
        <span class="temp-unit">&deg;F</span>
      </div>
      <div class="weather-details">
        <div class="condition-text" id="condition">&nbsp;</div>
        <div class="feels-like" id="feelslike">Feels like &mdash;&deg;</div>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card" data-metric="wind">
        <div class="stat-label">Wind</div>
        <div class="wind-compass">
          <div class="compass-ring"></div>
          <div class="compass-arrow" id="windArrow"></div>
          <div class="compass-dot"></div>
          <div class="compass-n">N</div>
        </div>
        <div class="stat-value"><span id="windSpeed">&mdash;</span> <span class="stat-unit">mph</span></div>
        <div class="stat-sub" id="windDir">--</div>
      </div>
      <div class="stat-card" data-metric="pressure">
        <div class="stat-label">Pressure</div>
        <div class="stat-value"><span id="pressure">&mdash;</span></div>
        <div class="stat-sub">inHg</div>
        <div class="pressure-bar"><div class="pressure-fill" id="pressureFill"></div><div class="pressure-marker" id="pressureMarker"></div></div>
        <div class="stat-sub" id="pressureTrend">&nbsp;</div>
      </div>
      <div class="stat-card" data-metric="humidity">
        <div class="stat-label">Humidity</div>
        <div class="stat-value"><span id="humidity">&mdash;</span><span class="stat-unit">%</span></div>
        <div class="stat-sub" id="dewpoint">Dew pt &mdash;&deg;</div>
      </div>
      <div class="stat-card" data-metric="uv">
        <div class="stat-label">UV Index</div>
        <div class="stat-value" id="uv">&mdash;</div>
        <div class="stat-sub" id="uvLabel">&nbsp;</div>
      </div>
      <div class="stat-card" data-metric="precip">
        <div class="stat-label">Precip</div>
        <div class="stat-value"><span id="precip">&mdash;</span><span class="stat-unit">%</span></div>
        <div class="stat-sub" id="precipAmt">&nbsp;</div>
      </div>
    </div>

    <div class="forecast-row" id="forecast"></div>
    </div>

    <div class="weather-view" id="view2">
      <div class="v2-header">
        <span class="v2-icon" id="v2Icon">--</span>
        <div>
          <div class="v2-temp"><span id="v2Temp">--</span><span class="v2-temp-unit">&deg;F</span></div>
          <div class="v2-cond" id="v2Cond">&nbsp;</div>
          <div class="v2-feels" id="v2Feels">&nbsp;</div>
        </div>
      </div>
      <div class="v2-gauges">
        <div class="gauge" data-metric="wind">
          <svg viewBox="0 0 120 120"><circle class="gauge-bg" cx="60" cy="60" r="50"/><circle class="gauge-arc" id="gWind" cx="60" cy="60" r="50" stroke="#64b4ff"/></svg>
          <div class="gauge-center"><div class="gauge-val" id="gWindVal">--</div><div class="gauge-unit">mph</div></div>
          <div class="gauge-name">Wind</div>
        </div>
        <div class="gauge" data-metric="pressure">
          <svg viewBox="0 0 120 120"><circle class="gauge-bg" cx="60" cy="60" r="50"/><circle class="gauge-arc" id="gPres" cx="60" cy="60" r="50" stroke="#82e0aa"/></svg>
          <div class="gauge-center"><div class="gauge-val" id="gPresVal">--</div><div class="gauge-unit">inHg</div></div>
          <div class="gauge-name">Pressure</div>
        </div>
        <div class="gauge" data-metric="humidity">
          <svg viewBox="0 0 120 120"><circle class="gauge-bg" cx="60" cy="60" r="50"/><circle class="gauge-arc" id="gHum" cx="60" cy="60" r="50" stroke="#7ec8e3"/></svg>
          <div class="gauge-center"><div class="gauge-val" id="gHumVal">--</div><div class="gauge-unit">%</div></div>
          <div class="gauge-name">Humidity</div>
        </div>
        <div class="gauge" data-metric="uv">
          <svg viewBox="0 0 120 120"><circle class="gauge-bg" cx="60" cy="60" r="50"/><circle class="gauge-arc" id="gUV" cx="60" cy="60" r="50" stroke="#f5c842"/></svg>
          <div class="gauge-center"><div class="gauge-val" id="gUVVal">--</div><div class="gauge-unit" id="gUVLabel">&nbsp;</div></div>
          <div class="gauge-name">UV Index</div>
        </div>
      </div>
      <div class="v2-extras">
        <div class="v2-extra" data-metric="precip"><div class="v2-extra-label">Precip</div><div class="v2-extra-val"><span id="v2Precip">--</span>%</div><div class="v2-extra-sub" id="v2PrecipAmt">&nbsp;</div></div>
        <div class="v2-extra"><div class="v2-extra-label">Dew Point</div><div class="v2-extra-val" id="v2Dew">--&deg;</div></div>
        <div class="v2-extra"><div class="v2-extra-label">Wind Dir</div><div class="v2-extra-val" id="v2WindDir">--</div></div>
      </div>
      <div class="v2-forecast" id="v2Forecast"></div>
    </div>

    <div class="weather-view" id="view3">
      <div class="v3-center">
        <span class="v3-icon" id="v3Icon">--</span>
        <div class="v3-temp-row">
          <span class="v3-temp" id="v3Temp">--</span>
          <span class="v3-unit">&deg;</span>
        </div>
        <div class="v3-cond" id="v3Cond">&nbsp;</div>
        <div class="v3-feels" id="v3Feels">&nbsp;</div>
      </div>
      <div class="v3-stats">
        <div class="v3-stat" data-metric="wind"><div class="v3-stat-val" id="v3Wind">-- mph</div><div class="v3-stat-label">Wind</div></div>
        <div class="v3-stat" data-metric="pressure"><div class="v3-stat-val" id="v3Pres">--</div><div class="v3-stat-label">Pressure</div></div>
        <div class="v3-stat" data-metric="humidity"><div class="v3-stat-val" id="v3Hum">--%</div><div class="v3-stat-label">Humidity</div></div>
        <div class="v3-stat" data-metric="uv"><div class="v3-stat-val" id="v3UV">--</div><div class="v3-stat-label">UV</div></div>
        <div class="v3-stat" data-metric="precip"><div class="v3-stat-val" id="v3Precip">--%</div><div class="v3-stat-label">Precip</div></div>
      </div>
      <div class="v3-forecast" id="v3Forecast"></div>
    </div>

    <div class="weather-view" id="view4">
      <div class="v4-header">
        <span class="v4-icon" id="v4Icon">--</span>
        <span class="v4-temp"><span id="v4Temp">--</span>&deg;F</span>
        <div class="v4-meta">
          <div class="v4-cond" id="v4Cond">&nbsp;</div>
          <div class="v4-feels" id="v4Feels">&nbsp;</div>
        </div>
      </div>
      <div class="data-grid">
        <div class="data-cell dc-wind" data-metric="wind"><div class="data-cell-label">Wind</div><div class="data-cell-val"><span id="v4Wind">--</span> <span class="data-cell-unit">mph</span></div><div class="data-cell-sub" id="v4WindDir">--</div></div>
        <div class="data-cell dc-pres" data-metric="pressure"><div class="data-cell-label">Pressure</div><div class="data-cell-val" id="v4Pres">--</div><div class="data-cell-sub" id="v4PresTrend">&nbsp;</div></div>
        <div class="data-cell dc-hum" data-metric="humidity"><div class="data-cell-label">Humidity</div><div class="data-cell-val"><span id="v4Hum">--</span><span class="data-cell-unit">%</span></div><div class="data-cell-sub" id="v4Dew">Dew --&deg;</div></div>
        <div class="data-cell dc-uv" data-metric="uv"><div class="data-cell-label">UV Index</div><div class="data-cell-val" id="v4UV">--</div><div class="data-cell-sub" id="v4UVLabel">&nbsp;</div></div>
        <div class="data-cell dc-precip" data-metric="precip"><div class="data-cell-label">Precip</div><div class="data-cell-val"><span id="v4Precip">--</span><span class="data-cell-unit">%</span></div><div class="data-cell-sub" id="v4PrecipAmt">&nbsp;</div></div>
        <div class="data-cell dc-dew" data-metric="humidity"><div class="data-cell-label">Dew Point</div><div class="data-cell-val" id="v4DewVal">--&deg;</div><div class="data-cell-sub">Temperature</div></div>
      </div>
      <div class="v4-forecast" id="v4Forecast"></div>
    </div>
  </div>

  <div class="lights-panel">
    <div class="lights-header">
      <div class="lights-title">Lights</div>
      <div class="lights-allbtns">
        <button class="lights-allbtn" id="all-on">On</button>
        <button class="lights-allbtn" id="all-off">Off</button>
      </div>
    </div>
    <div class="star-card" id="star-card" style="display:none">
      <div class="star-card-left"><span class="star-card-icon">&#x2B50;</span><span class="star-card-name">Star Lights</span></div>
      <div class="star-card-status" id="star-status">Off</div>
      <button class="toggle-btn" id="star-toggle"></button>
    </div>
    <div id="lights-container"></div>
    <div class="sports-section" id="sports-section">
      <div class="sports-header">Scores</div>
      <div id="sports-games"></div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   WEATHER DASHBOARD v4 - Portland
   ========================================================= */

/* ===== SCENE CANVAS (photorealistic Portland) ===== */
const scene = document.getElementById('sceneCanvas');
const sctx = scene.getContext('2d');
const SW = 1080, SH = 960; // 2x for retina-like quality
scene.width = SW; scene.height = SH;
scene.style.width = '540px'; scene.style.height = '480px';

let weatherCode = 0, isDay = true, windSpeedVal = 0, windDirVal = 0;
let hourlyData = null, dailyData = null, locData = null;

// Particles
let particles = [];
class Particle {
  constructor(type) { this.type = type; this.reset(); }
  reset() {
    this.x = Math.random() * SW;
    this.y = -10;
    this.speed = (1.5 + Math.random() * 3) * 2;
    this.opacity = 0.12 + Math.random() * 0.3;
    this.size = (1 + Math.random() * 2) * 2;
    if (this.type === 'snow') { this.speed *= 0.35; this.wobble = Math.random() * Math.PI * 2; this.wobbleSpeed = 0.02 + Math.random() * 0.03; }
    if (this.type === 'rain') { this.speed *= 1.6; this.length = (8 + Math.random() * 14) * 2; }
  }
  update() {
    const wp = (windSpeedVal / 25) * 3;
    if (this.type === 'rain') { this.y += this.speed * 2.2; this.x += wp; }
    else if (this.type === 'snow') { this.wobble += this.wobbleSpeed; this.y += this.speed; this.x += Math.sin(this.wobble) * 1.2 + wp * 0.5; }
    if (this.y > SH || this.x > SW + 40 || this.x < -40) this.reset();
  }
}

function setupParticles(code) {
  particles = [];
  const isRain = [51,53,55,61,63,65,66,67,80,81,82,95,96,99].includes(code);
  const isSnow = [71,73,75,77,85,86].includes(code);
  const isHeavy = [55,65,67,75,82,86,95,96,99].includes(code);
  const count = isHeavy ? 200 : 100;
  if (isRain) for (let i = 0; i < count; i++) { const p = new Particle('rain'); p.y = Math.random() * SH; particles.push(p); }
  if (isSnow) for (let i = 0; i < count; i++) { const p = new Particle('snow'); p.y = Math.random() * SH; particles.push(p); }
}

// Moon phase calculation
function getMoonPhase(date) {
  const d = date.getDate();
  const yr = date.getFullYear(), mo = date.getMonth() + 1;
  const yy = mo < 3 ? yr - 1 : yr;
  const mm = mo < 3 ? mo + 12 : mo;
  let c = 0, jd = 0, b = 0;
  c = Math.floor(yy / 100);
  b = 2 - c + Math.floor(c / 4);
  jd = Math.floor(365.25 * (yy + 4716)) + Math.floor(30.6001 * (mm + 1)) + d + b - 1524.5;
  const daysSinceNew = jd - 2451549.5;
  const newMoons = daysSinceNew / 29.53059;
  const phase = newMoons - Math.floor(newMoons);
  return phase;
}

function drawMoon(x, y, radius, phase) {
  const glow = sctx.createRadialGradient(x, y, radius * 0.8, x, y, radius * 2.5);
  glow.addColorStop(0, 'rgba(210,220,240,0.15)');
  glow.addColorStop(1, 'rgba(210,220,240,0)');
  sctx.fillStyle = glow;
  sctx.beginPath();
  sctx.arc(x, y, radius * 2.5, 0, Math.PI * 2);
  sctx.fill();

  sctx.globalAlpha = 1;
  const bodyGrad = sctx.createRadialGradient(x - radius * 0.2, y - radius * 0.2, 0, x, y, radius);
  bodyGrad.addColorStop(0, '#f0f2fa');
  bodyGrad.addColorStop(0.7, '#d8dce8');
  bodyGrad.addColorStop(1, '#c0c6d4');
  sctx.fillStyle = bodyGrad;
  sctx.beginPath();
  sctx.arc(x, y, radius, 0, Math.PI * 2);
  sctx.fill();

  const craters = [[0.28, -0.22, 0.14], [-0.22, 0.28, 0.10], [0.08, 0.08, 0.11], [-0.32, -0.12, 0.07], [0.22, 0.32, 0.06], [-0.1, -0.35, 0.05]];
  craters.forEach(([cx, cy, cr]) => {
    const cGrad = sctx.createRadialGradient(x + cx * radius, y + cy * radius, 0, x + cx * radius, y + cy * radius, cr * radius);
    cGrad.addColorStop(0, 'rgba(120,125,145,0.25)');
    cGrad.addColorStop(1, 'rgba(120,125,145,0)');
    sctx.fillStyle = cGrad;
    sctx.beginPath();
    sctx.arc(x + cx * radius, y + cy * radius, cr * radius, 0, Math.PI * 2);
    sctx.fill();
  });

  sctx.save();
  sctx.beginPath();
  sctx.arc(x, y, radius, 0, Math.PI * 2);
  sctx.clip();
  const shadowColor = 'rgba(6,10,20,0.93)';
  const p = phase;
  if (p < 0.01 || p > 0.99) {
    sctx.fillStyle = shadowColor;
    sctx.fillRect(x - radius - 2, y - radius - 2, radius * 2 + 4, radius * 2 + 4);
  } else if (p > 0.48 && p < 0.52) {
    // Full moon — no shadow
  } else {
    let offset;
    if (p < 0.5) { offset = radius * 2 * (1 - p * 2); }
    else { offset = -radius * 2 * ((p - 0.5) * 2); }
    const shadowCx = x - offset;
    sctx.fillStyle = shadowColor;
    sctx.beginPath();
    sctx.arc(shadowCx, y, radius, 0, Math.PI * 2);
    sctx.fill();
  }
  sctx.restore();
}

function drawStars(hour) {
  if (hour > 6 && hour < 19) return;
  const nightness = hour <= 6 ? 1 : hour >= 21 ? 1 : hour < 7 ? (7 - hour) : (hour - 19) / 2;
  sctx.globalAlpha = Math.min(1, nightness) * 0.6;
  const seed = 42;
  for (let i = 0; i < 80; i++) {
    const px = ((seed * (i + 1) * 7919) % SW);
    const py = ((seed * (i + 1) * 6271) % (SH * 0.45));
    const sz = ((i * 13) % 3) + 0.5;
    const twinkle = Math.sin(Date.now() * 0.001 + i * 2.3) * 0.3 + 0.7;
    sctx.globalAlpha = twinkle * Math.min(1, nightness) * 0.5;
    sctx.fillStyle = '#e8eeff';
    sctx.beginPath();
    sctx.arc(px, py, sz, 0, Math.PI * 2);
    sctx.fill();
  }
  sctx.globalAlpha = 1;
}

function renderScene() {
  const now = new Date();
  const hour = now.getHours() + now.getMinutes() / 60;

  let g = sctx.createLinearGradient(0, 0, 0, SH);
  if (hour < 5) {
    g.addColorStop(0, '#050a16'); g.addColorStop(0.4, '#0c1228'); g.addColorStop(1, '#0a0f1e');
  } else if (hour < 6.5) {
    const t = (hour - 5) / 1.5;
    g.addColorStop(0, `hsl(${225 - t * 15}, ${20 + t * 15}%, ${6 + t * 8}%)`);
    g.addColorStop(0.5, `hsl(${250 - t * 40}, ${15 + t * 30}%, ${8 + t * 12}%)`);
    g.addColorStop(0.8, `hsl(${30 - t * 10}, ${20 + t * 40}%, ${6 + t * 18}%)`);
    g.addColorStop(1, `hsl(${20}, ${25 + t * 20}%, ${6 + t * 10}%)`);
  } else if (hour < 8) {
    const t = (hour - 6.5) / 1.5;
    g.addColorStop(0, `hsl(${210 + t * 5}, ${35 + t * 10}%, ${14 + t * 12}%)`);
    g.addColorStop(0.4, `hsl(${35 - t * 10}, ${50 - t * 20}%, ${20 + t * 5}%)`);
    g.addColorStop(0.8, `hsl(${25}, ${40 - t * 15}%, ${18 + t * 5}%)`);
    g.addColorStop(1, `hsl(${210}, ${30 + t * 10}%, ${12 + t * 6}%)`);
  } else if (hour < 16) {
    g.addColorStop(0, '#1a3e62'); g.addColorStop(0.4, '#1e5280'); g.addColorStop(0.7, '#1b4570'); g.addColorStop(1, '#152e4c');
  } else if (hour < 18) {
    const t = (hour - 16) / 2;
    g.addColorStop(0, `hsl(${215 - t * 10}, ${42 - t * 2}%, ${28 - t * 2}%)`);
    g.addColorStop(0.3, `hsl(${30 + t * 5}, ${35 + t * 25}%, ${22 + t * 8}%)`);
    g.addColorStop(0.6, `hsl(${15 + t * 10}, ${40 + t * 25}%, ${18 + t * 10}%)`);
    g.addColorStop(1, `hsl(${250 + t * 10}, ${25 + t * 10}%, ${14 + t * 2}%)`);
  } else if (hour < 20) {
    const t = (hour - 18) / 2;
    g.addColorStop(0, `hsl(${245 + t * 5}, ${35 - t * 5}%, ${18 - t * 6}%)`);
    g.addColorStop(0.3, `hsl(${20 + t * 15}, ${55 - t * 25}%, ${25 - t * 10}%)`);
    g.addColorStop(0.6, `hsl(${265}, ${30 + t * 5}%, ${14 - t * 4}%)`);
    g.addColorStop(1, `hsl(${255}, ${25 + t * 5}%, ${12 - t * 4}%)`);
  } else if (hour < 21.5) {
    const t = (hour - 20) / 1.5;
    g.addColorStop(0, `hsl(${250}, ${28 - t * 8}%, ${10 - t * 3}%)`);
    g.addColorStop(0.5, `hsl(${258}, ${24 - t * 6}%, ${9 - t * 3}%)`);
    g.addColorStop(1, `hsl(${250}, ${20 - t * 5}%, ${7 - t * 2}%)`);
  } else {
    g.addColorStop(0, '#050a16'); g.addColorStop(0.4, '#0c1228'); g.addColorStop(1, '#0a0f1e');
  }

  sctx.clearRect(0, 0, SW, SH);
  sctx.globalAlpha = 0.35;
  sctx.fillStyle = g;
  sctx.fillRect(0, 0, SW, SH);
  sctx.globalAlpha = 1;

  if (hour > 5.5 && hour < 8) {
    const t = hour < 6.5 ? (hour - 5.5) : (8 - hour) / 1.5;
    const glowGrad = sctx.createRadialGradient(SW * 0.7, SH * 0.58, 0, SW * 0.7, SH * 0.58, 400);
    glowGrad.addColorStop(0, `rgba(255,140,50,${0.2 * t})`);
    glowGrad.addColorStop(0.4, `rgba(255,80,40,${0.1 * t})`);
    glowGrad.addColorStop(1, 'rgba(255,80,40,0)');
    sctx.fillStyle = glowGrad;
    sctx.fillRect(0, 0, SW, SH);
  }
  if (hour > 17 && hour < 20) {
    const t = hour < 18.5 ? (hour - 17) / 1.5 : (20 - hour) / 1.5;
    const glow2 = sctx.createRadialGradient(SW * 0.3, SH * 0.58, 0, SW * 0.3, SH * 0.58, 450);
    glow2.addColorStop(0, `rgba(255,100,40,${0.25 * t})`);
    glow2.addColorStop(0.3, `rgba(255,60,30,${0.12 * t})`);
    glow2.addColorStop(1, 'rgba(255,60,30,0)');
    sctx.fillStyle = glow2;
    sctx.fillRect(0, 0, SW, SH);
  }

  drawStars(hour);

  // Moon — very dim during daytime, moderate at night
  const moonAlpha = (hour >= 7 && hour < 18) ? 0.04 : (hour >= 6 && hour < 7) ? 0.04 + (7 - hour) * 0.56 : (hour >= 18 && hour < 20) ? 0.04 + (hour - 18) * 0.28 : 0.6;
  sctx.globalAlpha = moonAlpha;
  sctx.save();
  const moonPhase = getMoonPhase(now);
  drawMoon(SW * 0.82, SH * 0.22, 40, moonPhase);
  sctx.restore();
  sctx.globalAlpha = 1;

  if ([95, 96, 99].includes(weatherCode) && Math.random() < 0.004) {
    sctx.fillStyle = 'rgba(200,210,255,0.12)';
    sctx.fillRect(0, 0, SW, SH);
  }

  const windPush = (windSpeedVal / 25) * 3;
  particles.forEach(p => {
    p.update();
    sctx.globalAlpha = p.opacity;
    if (p.type === 'rain') {
      sctx.strokeStyle = '#8ec5ff';
      sctx.lineWidth = p.size * 0.5;
      sctx.beginPath();
      sctx.moveTo(p.x, p.y);
      sctx.lineTo(p.x - windPush, p.y - p.length);
      sctx.stroke();
    } else if (p.type === 'snow') {
      sctx.fillStyle = '#ddeeff';
      sctx.beginPath();
      sctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      sctx.fill();
    }
  });
  sctx.globalAlpha = 1;

  requestAnimationFrame(renderScene);
}

/* ===== CHART DRAWING ===== */
function drawChart(canvas, data, opts) {
  const ctx2 = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const pad = { top: 35, right: 30, bottom: 40, left: 55 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  ctx2.clearRect(0, 0, W, H);
  ctx2.fillStyle = 'rgba(8,12,24,0.6)';
  ctx2.fillRect(0, 0, W, H);

  if (!data || data.length === 0) {
    ctx2.fillStyle = 'rgba(255,255,255,0.3)';
    ctx2.font = '14px -apple-system, sans-serif';
    ctx2.textAlign = 'center';
    ctx2.fillText('No data available', W / 2, H / 2);
    return;
  }

  const values = data.map(d => d.v);
  let minV = Math.min(...values.filter(v => v !== null && v !== undefined));
  let maxV = Math.max(...values.filter(v => v !== null && v !== undefined));
  if (minV === maxV) { minV -= 1; maxV += 1; }
  const range = maxV - minV;
  const yPad = range * 0.1;
  minV -= yPad; maxV += yPad;

  const gridLines = 5;
  ctx2.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx2.lineWidth = 1;
  ctx2.font = '10px -apple-system, sans-serif';
  ctx2.fillStyle = 'rgba(255,255,255,0.3)';
  ctx2.textAlign = 'right';
  for (let i = 0; i <= gridLines; i++) {
    const y = pad.top + (ch / gridLines) * i;
    ctx2.beginPath(); ctx2.moveTo(pad.left, y); ctx2.lineTo(pad.left + cw, y); ctx2.stroke();
    const val = maxV - ((maxV - minV) / gridLines) * i;
    ctx2.fillText(opts.formatY ? opts.formatY(val) : val.toFixed(1), pad.left - 8, y + 4);
  }

  ctx2.textAlign = 'center';
  ctx2.fillStyle = 'rgba(255,255,255,0.3)';
  const labelInterval = Math.max(1, Math.floor(data.length / 8));
  data.forEach((d, i) => {
    if (i % labelInterval === 0) {
      const x = pad.left + (i / (data.length - 1)) * cw;
      ctx2.fillText(d.label || '', x, H - pad.bottom + 18);
      ctx2.strokeStyle = 'rgba(255,255,255,0.04)';
      ctx2.beginPath(); ctx2.moveTo(x, pad.top); ctx2.lineTo(x, pad.top + ch); ctx2.stroke();
    }
  });

  const fillGrad = ctx2.createLinearGradient(0, pad.top, 0, pad.top + ch);
  const c = opts.color || '#f5c842';
  fillGrad.addColorStop(0, c.replace(')', ',0.2)').replace('rgb', 'rgba'));
  fillGrad.addColorStop(1, c.replace(')', ',0.01)').replace('rgb', 'rgba'));

  ctx2.beginPath();
  let firstValid = true;
  data.forEach((d, i) => {
    if (d.v === null || d.v === undefined) return;
    const x = pad.left + (i / (data.length - 1)) * cw;
    const y = pad.top + ch - ((d.v - minV) / (maxV - minV)) * ch;
    if (firstValid) { ctx2.moveTo(x, y); firstValid = false; } else ctx2.lineTo(x, y);
  });
  ctx2.lineTo(pad.left + cw, pad.top + ch);
  ctx2.lineTo(pad.left, pad.top + ch);
  ctx2.closePath();
  ctx2.fillStyle = fillGrad;
  ctx2.fill();

  ctx2.beginPath();
  firstValid = true;
  data.forEach((d, i) => {
    if (d.v === null || d.v === undefined) return;
    const x = pad.left + (i / (data.length - 1)) * cw;
    const y = pad.top + ch - ((d.v - minV) / (maxV - minV)) * ch;
    if (firstValid) { ctx2.moveTo(x, y); firstValid = false; } else ctx2.lineTo(x, y);
  });
  ctx2.strokeStyle = c;
  ctx2.lineWidth = 2.5;
  ctx2.lineJoin = 'round';
  ctx2.lineCap = 'round';
  ctx2.stroke();

  const dotInterval = Math.max(1, Math.floor(data.length / 12));
  data.forEach((d, i) => {
    if (d.v === null || d.v === undefined) return;
    if (i % dotInterval !== 0 && i !== data.length - 1) return;
    const x = pad.left + (i / (data.length - 1)) * cw;
    const y = pad.top + ch - ((d.v - minV) / (maxV - minV)) * ch;
    ctx2.beginPath(); ctx2.arc(x, y, 3, 0, Math.PI * 2);
    ctx2.fillStyle = c; ctx2.fill();
    ctx2.strokeStyle = 'rgba(0,0,0,0.4)'; ctx2.lineWidth = 1; ctx2.stroke();
  });

  ctx2.font = 'bold 13px -apple-system, sans-serif';
  ctx2.fillStyle = 'rgba(255,255,255,0.7)';
  ctx2.textAlign = 'left';
  ctx2.fillText(opts.title || '', pad.left, 20);
  if (opts.unit) {
    ctx2.font = '10px -apple-system, sans-serif';
    ctx2.fillStyle = 'rgba(255,255,255,0.35)';
    ctx2.fillText(opts.unit, pad.left + ctx2.measureText(opts.title || '').width + 10, 20);
  }
  if (opts.currentValue !== undefined) {
    ctx2.font = 'bold 14px -apple-system, sans-serif';
    ctx2.fillStyle = c;
    ctx2.textAlign = 'right';
    ctx2.fillText('Now: ' + (opts.formatY ? opts.formatY(opts.currentValue) : opts.currentValue.toFixed(1)) + (opts.unitLabel || ''), W - pad.right, 20);
  }
}

/* ===== WEATHER DATA ===== */
const WMO = {0:{t:'Clear Sky',i:'\u2600',n:'\u263E'},1:{t:'Mostly Clear',i:'\u2600',n:'\u263E'},2:{t:'Partly Cloudy',i:'\u26C5',n:'\u2601'},3:{t:'Overcast',i:'\u2601',n:'\u2601'},45:{t:'Foggy',i:'\u2588',n:'\u2588'},48:{t:'Rime Fog',i:'\u2588',n:'\u2588'},51:{t:'Light Drizzle',i:'\u2602',n:'\u2602'},53:{t:'Drizzle',i:'\u2602',n:'\u2602'},55:{t:'Heavy Drizzle',i:'\u2602',n:'\u2602'},61:{t:'Light Rain',i:'\u2602',n:'\u2602'},63:{t:'Rain',i:'\u2602',n:'\u2602'},65:{t:'Heavy Rain',i:'\u2602',n:'\u2602'},66:{t:'Freezing Rain',i:'\u2744',n:'\u2744'},67:{t:'Hvy Freezing Rain',i:'\u2744',n:'\u2744'},71:{t:'Light Snow',i:'\u2744',n:'\u2744'},73:{t:'Snow',i:'\u2744',n:'\u2744'},75:{t:'Heavy Snow',i:'\u2744',n:'\u2744'},77:{t:'Snow Grains',i:'\u2744',n:'\u2744'},80:{t:'Light Showers',i:'\u2602',n:'\u2602'},81:{t:'Showers',i:'\u2602',n:'\u2602'},82:{t:'Heavy Showers',i:'\u2608',n:'\u2608'},85:{t:'Snow Showers',i:'\u2744',n:'\u2744'},86:{t:'Hvy Snow Showers',i:'\u2744',n:'\u2744'},95:{t:'Thunderstorm',i:'\u2608',n:'\u2608'},96:{t:'T-storm + Hail',i:'\u2608',n:'\u2608'},99:{t:'Severe T-storm',i:'\u2608',n:'\u2608'}};
const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DIR_NAMES = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];

function wInfo(code, night) { const e = WMO[code] || {t:'Unknown',i:'\u2600',n:'\u263E'}; return {text:e.t, icon:night?e.n:e.i}; }
function degToDir(deg) { return DIR_NAMES[Math.round(deg / 22.5) % 16]; }
function uvLabel(uv) { if (uv <= 2) return 'Low'; if (uv <= 5) return 'Moderate'; if (uv <= 7) return 'High'; if (uv <= 10) return 'Very High'; return 'Extreme'; }

function updateClock() {
  const now = new Date(), h = now.getHours(), m = String(now.getMinutes()).padStart(2, '0');
  document.getElementById('time').textContent = `${h % 12 || 12}:${m} ${h >= 12 ? 'PM' : 'AM'}`;
  document.getElementById('date').textContent = `${DAYS[now.getDay()]}, ${MONTHS[now.getMonth()]} ${now.getDate()}`;
}

let lastPressure = null;
async function loadWeather() {
  try {
    const loc = await (await fetch('http://ip-api.com/json/?fields=lat,lon,city,regionName')).json();
    locData = loc;
    document.getElementById('location').textContent = loc.city + ', ' + loc.regionName;

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}` +
      `&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,surface_pressure,is_day,dew_point_2m` +
      `&hourly=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,visibility,uv_index,precipitation_probability,precipitation,weather_code` +
      `&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max,precipitation_probability_max,precipitation_sum,sunrise,sunset,wind_speed_10m_max` +
      `&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto&forecast_days=7&past_days=1`;
    const w = await (await fetch(url)).json();
    const c = w.current, d = w.daily;
    hourlyData = w.hourly;
    dailyData = d;
    isDay = !!c.is_day;
    weatherCode = c.weather_code;

    // Fetch real sensor data from WS-2902 via Ambient Weather API
    let station = null;
    try {
      const sResp = await fetch('/api/station');
      const sData = await sResp.json();
      if (sData && sData.latest) station = sData.latest;
    } catch (e) { console.warn('Station fetch failed:', e); }

    // Show sensor badge if WS-2902 is live
    document.getElementById('sensorBadge').style.display = station ? 'inline' : 'none';

    // Use WS-2902 sensor data when available, fall back to Open-Meteo
    const tempF = station && station.temp_f != null ? station.temp_f : c.temperature_2m;
    const feelsF = station && station.feels_like_f != null ? station.feels_like_f : c.apparent_temperature;
    const humPct = station && station.humidity != null ? station.humidity : c.relative_humidity_2m;
    const windMph = station && station.wind_speed != null ? station.wind_speed : c.wind_speed_10m;
    const windDeg = station && station.wind_dir != null ? station.wind_dir : c.wind_direction_10m;
    const presInHg = station && station.pressure_rel != null ? station.pressure_rel : (c.surface_pressure * 0.02953);
    const dewF = station && station.dew_point_f != null ? station.dew_point_f : c.dew_point_2m;
    const uvIdx = station && station.uv != null ? station.uv : d.uv_index_max[1];
    const solarRad = station ? station.solar_radiation : null;
    const dailyRain = station ? station.daily_rain : null;

    windSpeedVal = windMph;
    windDirVal = windDeg;
    const info = wInfo(c.weather_code, !isDay);

    document.getElementById('temp').textContent = Math.round(tempF);
    document.getElementById('weatherIcon').textContent = info.icon;
    document.getElementById('condition').textContent = info.text;
    document.getElementById('feelslike').textContent = `Feels like ${Math.round(feelsF)}\u00B0`;

    document.getElementById('windSpeed').textContent = Math.round(windMph);
    document.getElementById('windDir').textContent = degToDir(windDeg);
    document.getElementById('windArrow').style.transform = `translate(-50%,-100%) rotate(${windDeg}deg)`;

    const inHg = presInHg.toFixed(2);
    document.getElementById('pressure').textContent = inHg;
    const pPct = Math.max(0, Math.min(100, ((parseFloat(inHg) - 29.4) / (30.8 - 29.4)) * 100));
    document.getElementById('pressureFill').style.width = pPct + '%';
    document.getElementById('pressureMarker').style.left = pPct + '%';
    if (lastPressure !== null) {
      const diff = parseFloat(inHg) - lastPressure;
      document.getElementById('pressureTrend').textContent = diff > 0.01 ? '\u2191 Rising' : diff < -0.01 ? '\u2193 Falling' : '\u2192 Steady';
    }
    lastPressure = parseFloat(inHg);

    document.getElementById('humidity').textContent = humPct;
    if (dewF != null) document.getElementById('dewpoint').textContent = `Dew pt ${Math.round(dewF)}\u00B0`;

    document.getElementById('uv').textContent = parseFloat(uvIdx).toFixed(1);
    document.getElementById('uvLabel').textContent = uvLabel(parseFloat(uvIdx));

    const nowHour = new Date().getHours();
    if (w.hourly && w.hourly.precipitation_probability) {
      const hourIdx = 24 + nowHour;
      const precipProb = w.hourly.precipitation_probability[hourIdx] || 0;
      document.getElementById('precip').textContent = precipProb;
      if (dailyRain != null && dailyRain > 0) {
        document.getElementById('precipAmt').textContent = `${dailyRain.toFixed(2)} in today`;
      } else {
        const precipAmt = w.hourly.precipitation ? w.hourly.precipitation[hourIdx] : 0;
        document.getElementById('precipAmt').textContent = precipAmt > 0 ? `${precipAmt.toFixed(2)} in` : 'None';
      }
    }

    // Forecast (skip past day: index 1 = today)
    const fc = document.getElementById('forecast'); fc.innerHTML = '';
    for (let i = 1; i <= 3; i++) {
      const dt = new Date(d.time[i] + 'T12:00:00');
      const nm = i === 1 ? 'Today' : DAYS[dt.getDay()];
      const fi = wInfo(d.weather_code[i], false);
      const rain = d.precipitation_probability_max ? d.precipitation_probability_max[i] : null;
      const div = document.createElement('div');
      div.className = 'fc-day' + (i === 1 ? ' today' : '');
      div.innerHTML = `<span class="fc-name">${nm}</span><span class="fc-icon">${fi.icon}</span><div class="fc-temps"><span class="fc-hi">${Math.round(d.temperature_2m_max[i])}\u00B0</span><span class="fc-lo">${Math.round(d.temperature_2m_min[i])}\u00B0</span></div>${rain != null && rain > 0 ? `<span class="fc-rain">${rain}%</span>` : ''}`;
      div.addEventListener('click', () => showForecastDetail(i));
      fc.appendChild(div);
    }

    setupParticles(weatherCode);
    renderViews();
  } catch (e) { console.error('Weather:', e); }
}

/* ===== STAT CARD TAPPING (24h history) ===== */
const metricConfig = {
  wind: { key: 'wind_speed_10m', title: 'Wind Speed', unit: 'mph', color: 'rgb(100,180,255)', formatY: v => v.toFixed(0), unitLabel: ' mph' },
  pressure: { key: 'surface_pressure', title: 'Barometric Pressure', unit: 'inHg', color: 'rgb(130,224,170)', transform: v => v !== null ? (v * 0.02953) : null, formatY: v => v.toFixed(2), unitLabel: ' inHg' },
  humidity: { key: 'relative_humidity_2m', title: 'Relative Humidity', unit: '%', color: 'rgb(100,200,255)', formatY: v => v.toFixed(0), unitLabel: '%' },
  uv: { key: 'uv_index', title: 'UV Index', unit: '', color: 'rgb(245,200,66)', formatY: v => v.toFixed(1), unitLabel: '' },
  precip: { key: 'precipitation_probability', title: 'Precipitation', unit: '%', color: 'rgb(100,180,255)', formatY: v => v.toFixed(0), unitLabel: '%' }
};

document.querySelectorAll('.stat-card[data-metric]').forEach(card => {
  card.addEventListener('click', () => showStatHistory(card.dataset.metric));
});

function showStatHistory(metric) {
  if (!hourlyData) return;
  const cfg = metricConfig[metric];
  if (!cfg) return;
  const overlay = document.getElementById('statOverlay');
  const canvas = document.getElementById('statChart');
  document.getElementById('statOverlayTitle').textContent = cfg.title + ' \u2014 Last 24 Hours';
  const nowHour = new Date().getHours();
  const startIdx = nowHour, endIdx = startIdx + 24;
  const rawValues = hourlyData[cfg.key];
  const times = hourlyData.time;
  if (!rawValues) return;
  const chartData = [];
  for (let i = startIdx; i <= endIdx && i < rawValues.length; i++) {
    let v = rawValues[i];
    if (cfg.transform && v !== null) v = cfg.transform(v);
    const t = new Date(times[i]);
    const label = t.getHours() === 0 ? '12a' : t.getHours() < 12 ? t.getHours() + 'a' : t.getHours() === 12 ? '12p' : (t.getHours() - 12) + 'p';
    chartData.push({ v, label });
  }
  let curVal = rawValues[endIdx - 1];
  if (cfg.transform && curVal !== null) curVal = cfg.transform(curVal);
  drawChart(canvas, chartData, { title: cfg.title, unit: cfg.unit, color: cfg.color, formatY: cfg.formatY, unitLabel: cfg.unitLabel, currentValue: curVal });
  overlay.classList.add('show');
}

document.getElementById('statOverlay').addEventListener('click', () => {
  document.getElementById('statOverlay').classList.remove('show');
});

/* ===== FORECAST DETAIL OVERLAY ===== */
function showForecastDetail(dayIdx) {
  if (!dailyData || !hourlyData) return;
  const overlay = document.getElementById('fcOverlay');
  const d = dailyData;
  const dt = new Date(d.time[dayIdx] + 'T12:00:00');
  const dayName = dayIdx === 1 ? 'Today' : `${DAYS[dt.getDay()]}, ${MONTHS[dt.getMonth()]} ${dt.getDate()}`;
  const fi = wInfo(d.weather_code[dayIdx], false);

  document.getElementById('fcOverlayTitle').textContent = dayName;
  document.getElementById('fcHi').textContent = Math.round(d.temperature_2m_max[dayIdx]) + '\u00B0F';
  document.getElementById('fcLo').textContent = Math.round(d.temperature_2m_min[dayIdx]) + '\u00B0F';
  document.getElementById('fcCondition').innerHTML = `<span style="font-size:22px">${fi.icon}</span> ${fi.text}`;

  const stats = document.getElementById('fcStats');
  const sunrise = d.sunrise ? d.sunrise[dayIdx] : null;
  const sunset = d.sunset ? d.sunset[dayIdx] : null;
  const fmtTime = t => {
    if (!t) return '--';
    const dt2 = new Date(t);
    const h = dt2.getHours(), m = String(dt2.getMinutes()).padStart(2, '0');
    return `${h % 12 || 12}:${m} ${h >= 12 ? 'PM' : 'AM'}`;
  };
  const statsHTML = [
    ['Sunrise', fmtTime(sunrise)], ['Sunset', fmtTime(sunset)],
    ['Max Wind', (d.wind_speed_10m_max ? Math.round(d.wind_speed_10m_max[dayIdx]) + ' mph' : '--')],
    ['Precip Total', (d.precipitation_sum ? d.precipitation_sum[dayIdx].toFixed(2) + ' in' : '--')],
    ['Precip Chance', (d.precipitation_probability_max ? d.precipitation_probability_max[dayIdx] + '%' : '--')],
    ['UV Index', (d.uv_index_max ? d.uv_index_max[dayIdx].toFixed(1) + ' (' + uvLabel(d.uv_index_max[dayIdx]) + ')' : '--')],
    ['High', Math.round(d.temperature_2m_max[dayIdx]) + '\u00B0F'],
    ['Low', Math.round(d.temperature_2m_min[dayIdx]) + '\u00B0F'],
  ];
  stats.innerHTML = statsHTML.map(([l, v]) => `<div class="fc-detail-stat"><span class="fc-detail-stat-label">${l}</span><span class="fc-detail-stat-val">${v}</span></div>`).join('');

  const canvas = document.getElementById('fcChart');
  const hourStart = dayIdx * 24;
  const tempData = [];
  for (let h = 0; h < 24; h++) {
    const idx = hourStart + h;
    if (idx >= hourlyData.temperature_2m.length) break;
    const v = hourlyData.temperature_2m[idx];
    const label = h === 0 ? '12a' : h < 12 ? h + 'a' : h === 12 ? '12p' : (h - 12) + 'p';
    tempData.push({ v, label });
  }
  drawChart(canvas, tempData, { title: 'Hourly Temperature', unit: '\u00B0F', color: 'rgb(245,160,70)', formatY: v => Math.round(v) + '\u00B0', unitLabel: '\u00B0F' });
  overlay.classList.add('show');
}

document.getElementById('fcOverlay').addEventListener('click', (e) => {
  if (e.target === document.getElementById('fcOverlay')) document.getElementById('fcOverlay').classList.remove('show');
});
document.querySelector('#fcOverlay .overlay-content').addEventListener('click', () => {
  document.getElementById('fcOverlay').classList.remove('show');
});

/* ===== LIGHTS ===== */
const LIGHT_ORDER = ['parlor', 'octagon', 'kitchen_left', 'kitchen_right'];
const LIGHT_NAMES = { parlor: 'Parlor', octagon: 'Octagon', kitchen_left: 'Kitchen L', kitchen_right: 'Kitchen R' };
const KITCHEN_LIGHTS = ['kitchen_left', 'kitchen_right'];
const lightState = {};

const COLOR_SWATCHES = [
  { name: 'Warm', r: 255, g: 180, b: 100, css: '#ffb464' },
  { name: 'Cool', r: 200, g: 220, b: 255, css: '#c8dcff' },
  { name: 'Red', r: 255, g: 30, b: 30, css: '#ff1e1e' },
  { name: 'Orange', r: 255, g: 120, b: 0, css: '#ff7800' },
  { name: 'Green', r: 0, g: 200, b: 80, css: '#00c850' },
  { name: 'Blue', r: 0, g: 100, b: 255, css: '#0064ff' },
  { name: 'Purple', r: 150, g: 50, b: 255, css: '#9632ff' },
];

function buildLights(data) {
  const ct = document.getElementById('lights-container'); ct.innerHTML = '';
  for (const id of LIGHT_ORDER) {
    const info = data[id]; if (!info) continue;
    const br = info.brightness || 0, isOn = info.on && br > 0;
    lightState[id] = { on: isOn, brightness: isOn ? br : 0, lastBr: br || 100 };
    const card = document.createElement('div');
    card.className = 'light-card' + (isOn ? ' on' : '');
    card.id = 'lc-' + id;

    let colorHTML = '';
    if (KITCHEN_LIGHTS.includes(id)) {
      colorHTML = '<div class="color-swatches" id="colors-' + id + '">' +
        COLOR_SWATCHES.map((c, i) => `<div class="color-swatch" data-light="${id}" data-idx="${i}" style="background:${c.css};" title="${c.name}"></div>`).join('') + '</div>';
    }

    card.innerHTML = `<div class="light-top"><div class="light-info"><div class="light-name">${LIGHT_NAMES[id]}</div><div class="light-pct" id="pct-${id}">${isOn ? br + '%' : 'Off'}</div></div><div class="light-slider" id="track-${id}"><div class="slider-bg"><div class="slider-fill" id="fill-${id}" style="width:${br}%"></div></div><div class="slider-thumb" id="thumb-${id}" style="left:${br}%"></div></div><button class="toggle-btn${isOn ? ' on' : ''}" id="tog-${id}"></button></div>${colorHTML}`;
    ct.appendChild(card);

    document.getElementById('tog-' + id).addEventListener('click', () => {
      const s = lightState[id];
      s.on ? sendLight(id, 0) : sendLight(id, s.lastBr || 100);
    });
    setupSlider(id);

    if (KITCHEN_LIGHTS.includes(id)) {
      card.querySelectorAll('.color-swatch').forEach(sw => {
        sw.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(sw.dataset.idx);
          const color = COLOR_SWATCHES[idx];
          card.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
          sw.classList.add('active');
          sendColor(id, color.r, color.g, color.b);
        });
      });
    }
  }
}

function setupSlider(id) {
  const track = document.getElementById('track-' + id);
  let drag = false;
  function pct(e) {
    const r = track.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    return Math.max(0, Math.min(100, Math.round(((cx - r.left) / r.width) * 100)));
  }
  track.addEventListener('mousedown', e => { drag = true; updateUI(id, pct(e)); });
  track.addEventListener('touchstart', e => { drag = true; updateUI(id, pct(e)); }, { passive: true });
  window.addEventListener('mousemove', e => { if (drag) { e.preventDefault(); updateUI(id, pct(e)); } });
  window.addEventListener('touchmove', e => { if (drag) updateUI(id, pct(e)); }, { passive: true });
  window.addEventListener('mouseup', () => { if (drag) { drag = false; sendLight(id, lightState[id].brightness); } });
  window.addEventListener('touchend', () => { if (drag) { drag = false; sendLight(id, lightState[id].brightness); } });
}

function updateUI(id, p) {
  document.getElementById('fill-' + id).style.width = p + '%';
  document.getElementById('thumb-' + id).style.left = p + '%';
  document.getElementById('pct-' + id).textContent = p > 0 ? p + '%' : 'Off';
  const on = p > 0;
  document.getElementById('lc-' + id).className = 'light-card' + (on ? ' on' : '');
  document.getElementById('tog-' + id).className = 'toggle-btn' + (on ? ' on' : '');
  lightState[id].brightness = p; lightState[id].on = on; if (p > 0) lightState[id].lastBr = p;
}

let st = {};
function sendLight(id, br) {
  updateUI(id, br);
  clearTimeout(st[id]);
  st[id] = setTimeout(async () => {
    try { await fetch(`/lights/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ brightness: br }) }); } catch (e) {}
  }, 200);
}

function sendColor(id, r, g, b) {
  clearTimeout(st['color_' + id]);
  st['color_' + id] = setTimeout(async () => {
    try { await fetch(`/lights/${id}/color`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ r, g, b }) }); } catch (e) {}
  }, 200);
}

document.getElementById('all-on').addEventListener('click', () => {
  LIGHT_ORDER.forEach(id => sendLight(id, 100));
  updateStarUI(true);
  fetch('/hubspace/' + STAR_ID, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ on: true }) }).catch(() => {});
});
document.getElementById('all-off').addEventListener('click', () => {
  LIGHT_ORDER.forEach(id => sendLight(id, 0));
  updateStarUI(false);
  fetch('/hubspace/' + STAR_ID, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ on: false }) }).catch(() => {});
});

/* ===== STAR LIGHTS (Hubspace) ===== */
const STAR_ID = 'e37b719e-290a-4c6a-9a9c-bfbba2f43723';
let starOn = false;

function updateStarUI(on) {
  starOn = on;
  const card = document.getElementById('star-card');
  const status = document.getElementById('star-status');
  const tog = document.getElementById('star-toggle');
  card.className = 'star-card' + (on ? ' on' : '');
  status.textContent = on ? 'On' : 'Off';
  tog.className = 'toggle-btn' + (on ? ' on' : '');
}

document.getElementById('star-toggle').addEventListener('click', (e) => {
  e.stopPropagation();
  const newState = !starOn;
  updateStarUI(newState);
  fetch('/hubspace/' + STAR_ID, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ on: newState }),
  }).catch(() => {});
});

document.getElementById('star-card').addEventListener('click', () => {
  const newState = !starOn;
  updateStarUI(newState);
  fetch('/hubspace/' + STAR_ID, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ on: newState }),
  }).catch(() => {});
});

async function loadStarLights() {
  try {
    const data = await (await fetch('/hubspace')).json();
    const star = data[STAR_ID];
    if (star) {
      document.getElementById('star-card').style.display = 'flex';
      updateStarUI(!!star.on);
    }
  } catch (e) {
    // Hubspace not available — hide the card
    document.getElementById('star-card').style.display = 'none';
  }
}

async function loadLights() {
  try {
    const data = await (await fetch('/lights')).json();
    buildLights(data);
  } catch (e) {
    const fb = {};
    LIGHT_ORDER.forEach(id => { fb[id] = { name: LIGHT_NAMES[id], on: false, brightness: 0 }; });
    buildLights(fb);
  }
  loadStarLights();
}

/* ===== WEBCAM BACKGROUND ===== */
const CAM_SOURCES = [
  { url: '/api/webcam?source=spirit', name: 'Spirit' },
  { url: '/api/webcam?source=youtube', name: 'YT Live' },
];
let currentCamIdx = 0;

function refreshWebcam() {
  const img = document.getElementById('webcamImg');
  const stamp = document.getElementById('camStamp');
  const src = CAM_SOURCES[currentCamIdx];
  img.src = src.url + '?' + Date.now();
  img.onload = function() {
    const now = new Date();
    const h = now.getHours() % 12 || 12;
    const m = String(now.getMinutes()).padStart(2, '0');
    const ap = now.getHours() >= 12 ? 'PM' : 'AM';
    stamp.textContent = `${src.name} ${h}:${m} ${ap}`;
  };
  img.onerror = function() {
    // Try next source as fallback
    const fallbackIdx = (currentCamIdx + 1) % CAM_SOURCES.length;
    const fb = CAM_SOURCES[fallbackIdx];
    this.src = fb.url + '?' + Date.now();
  };
}

function rotateCamSource() {
  currentCamIdx = (currentCamIdx + 1) % CAM_SOURCES.length;
  refreshWebcam();
}

/* ===== SPORTS SCORES ===== */
let sportsGames = []; // store for click detail

function formatGameTime(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    const h = d.getHours(), m = String(d.getMinutes()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    const day = DAYS[d.getDay()];
    const mon = MONTHS[d.getMonth()];
    return `${day} ${mon} ${d.getDate()}, ${h12}:${m} ${ampm}`;
  } catch (e) { return ''; }
}

function formatShortTime(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    const h = d.getHours(), m = String(d.getMinutes()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    return `${h % 12 || 12}:${m} ${ampm}`;
  } catch (e) { return ''; }
}

async function loadSports() {
  try {
    const resp = await fetch('/api/sports');
    const data = await resp.json();
    sportsGames = data.games || [];
    const container = document.getElementById('sports-games');
    container.innerHTML = '';

    const show = sportsGames.slice(0, 2);
    if (show.length === 0) {
      container.innerHTML = '<div style="font-size:9px;color:var(--fg-muted);text-align:center;padding:4px;">No games today</div>';
      return;
    }

    show.forEach((g, idx) => {
      const isLive = g.state === 'in';
      const isPre = g.state === 'pre';
      // For scheduled games, show start time instead of "Scheduled"
      let statusText = g.detail;
      if (isPre && (statusText === 'Scheduled' || !statusText) && g.date) {
        statusText = formatShortTime(g.date);
      }
      const card = document.createElement('div');
      card.className = 'game-card' + (isLive ? ' live' : '');
      card.innerHTML = `<div class="game-league">${g.league}</div><div class="game-row"><span class="game-team">${g.away.abbr}</span><span class="game-score">${isPre ? '' : g.away.score}</span></div><div class="game-row"><span class="game-team">${g.home.abbr}</span><span class="game-score">${isPre ? '' : g.home.score}</span></div><div class="game-status${isLive ? ' live-text' : ''}">${statusText}</div>`;
      card.addEventListener('click', () => showGameDetail(idx));
      container.appendChild(card);
    });
  } catch (e) {
    console.log('Sports:', e);
  }
}

function showGameDetail(idx) {
  const g = sportsGames[idx];
  if (!g) return;
  const overlay = document.getElementById('gameOverlay');
  const isLive = g.state === 'in';
  const isPre = g.state === 'pre';

  document.getElementById('gdLeague').textContent = g.league;
  const statusEl = document.getElementById('gdStatus');
  statusEl.textContent = g.fullDetail || g.detail;
  statusEl.className = 'gd-status' + (isLive ? ' live' : '');

  document.getElementById('gdAwayName').textContent = g.away.name;
  document.getElementById('gdAwayScore').textContent = isPre ? '' : g.away.score;
  document.getElementById('gdAwayRecord').textContent = g.away.record ? `(${g.away.record})` : '';
  document.getElementById('gdAwayLogo').src = g.away.logo || '';

  document.getElementById('gdHomeName').textContent = g.home.name;
  document.getElementById('gdHomeScore').textContent = isPre ? '' : g.home.score;
  document.getElementById('gdHomeRecord').textContent = g.home.record ? `(${g.home.record})` : '';
  document.getElementById('gdHomeLogo').src = g.home.logo || '';

  // Info rows
  const info = document.getElementById('gdInfo');
  const rows = [];
  if (g.date) rows.push(['Start', formatGameTime(g.date)]);
  if (g.venue) rows.push(['Venue', g.venue + (g.venueCity ? `, ${g.venueCity}` : '')]);
  if (g.broadcast) rows.push(['Watch', g.broadcast]);
  info.innerHTML = rows.map(([l, v]) => `<div class="gd-info-row"><span class="gd-info-label">${l}</span><span class="gd-info-val">${v}</span></div>`).join('');

  overlay.classList.add('show');
}

document.getElementById('gameOverlay').addEventListener('click', () => {
  document.getElementById('gameOverlay').classList.remove('show');
});

/* ===== LAYOUT TABS + AUTO-ROTATION ===== */
let currentView = 1;
let viewRotationTimer = null;

function switchView(viewNum) {
  currentView = viewNum;
  document.querySelectorAll('.layout-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.weather-view').forEach(v => v.classList.remove('active'));
  const tab = document.querySelector('.layout-tab[data-view="' + viewNum + '"]');
  if (tab) tab.classList.add('active');
  document.getElementById('view' + viewNum).classList.add('active');
}

function autoRotateView() {
  const next = (currentView % 4) + 1;
  switchView(next);
}

document.querySelectorAll('.layout-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    switchView(parseInt(tab.dataset.view));
  });
});

/* ===== ALTERNATE LAYOUT RENDERING ===== */
const GAUGE_CIRC = 314.16;
const GAUGE_ARC = 235.6;

function setGauge(id, pct) {
  const el = document.getElementById(id);
  if (!el) return;
  const fill = Math.max(0, Math.min(100, pct)) / 100 * GAUGE_ARC;
  el.setAttribute('stroke-dasharray', fill + ' ' + (GAUGE_CIRC - fill));
}

function renderViews() {
  if (!dailyData) return;

  // Read current values from Layout 1 elements
  const temp = document.getElementById('temp').textContent;
  const icon = document.getElementById('weatherIcon').textContent;
  const condition = document.getElementById('condition').textContent;
  const feelsText = document.getElementById('feelslike').textContent;
  const windSpd = document.getElementById('windSpeed').textContent;
  const windDir = document.getElementById('windDir').textContent;
  const pressure = document.getElementById('pressure').textContent;
  const humidity = document.getElementById('humidity').textContent;
  const dewpoint = document.getElementById('dewpoint').textContent;
  const uv = document.getElementById('uv').textContent;
  const uvLbl = document.getElementById('uvLabel').textContent;
  const precip = document.getElementById('precip').textContent;
  const precipAmt = document.getElementById('precipAmt').textContent;
  const pressTrend = document.getElementById('pressureTrend').textContent;

  // === View 2: Cockpit ===
  document.getElementById('v2Temp').textContent = temp;
  document.getElementById('v2Icon').textContent = icon;
  document.getElementById('v2Cond').textContent = condition;
  document.getElementById('v2Feels').textContent = feelsText;
  document.getElementById('gWindVal').textContent = windSpd;
  document.getElementById('gPresVal').textContent = pressure;
  document.getElementById('gHumVal').textContent = humidity;
  document.getElementById('gUVVal').textContent = uv;
  document.getElementById('gUVLabel').textContent = uvLbl;
  document.getElementById('v2Precip').textContent = precip;
  document.getElementById('v2PrecipAmt').textContent = precipAmt;
  document.getElementById('v2Dew').textContent = dewpoint.replace('Dew pt ', '');
  document.getElementById('v2WindDir').textContent = windDir;

  setGauge('gWind', Math.min(100, (parseInt(windSpd) || 0) / 40 * 100));
  const presVal = parseFloat(pressure) || 30.0;
  setGauge('gPres', ((presVal - 29.4) / (30.8 - 29.4)) * 100);
  setGauge('gHum', parseInt(humidity) || 0);
  setGauge('gUV', Math.min(100, (parseFloat(uv) || 0) / 11 * 100));

  // === View 3: Horizon ===
  document.getElementById('v3Temp').textContent = temp;
  document.getElementById('v3Icon').textContent = icon;
  document.getElementById('v3Cond').textContent = condition;
  document.getElementById('v3Feels').textContent = feelsText;
  document.getElementById('v3Wind').textContent = windSpd + ' mph';
  document.getElementById('v3Pres').textContent = pressure;
  document.getElementById('v3Hum').textContent = humidity + '%';
  document.getElementById('v3UV').textContent = uv;
  document.getElementById('v3Precip').textContent = precip + '%';

  // === View 4: Grid ===
  document.getElementById('v4Temp').textContent = temp;
  document.getElementById('v4Icon').textContent = icon;
  document.getElementById('v4Cond').textContent = condition;
  document.getElementById('v4Feels').textContent = feelsText;
  document.getElementById('v4Wind').textContent = windSpd;
  document.getElementById('v4WindDir').textContent = windDir;
  document.getElementById('v4Pres').textContent = pressure;
  document.getElementById('v4PresTrend').textContent = pressTrend;
  document.getElementById('v4Hum').textContent = humidity;
  document.getElementById('v4Dew').textContent = dewpoint;
  document.getElementById('v4UV').textContent = uv;
  document.getElementById('v4UVLabel').textContent = uvLbl;
  document.getElementById('v4Precip').textContent = precip;
  document.getElementById('v4PrecipAmt').textContent = precipAmt;
  const dewMatch = dewpoint.match(/\d+/);
  document.getElementById('v4DewVal').textContent = (dewMatch ? dewMatch[0] : '--') + '\u00B0';

  // Render forecasts for alternate views
  renderAltForecasts();
}

function renderAltForecasts() {
  if (!dailyData) return;
  const d = dailyData;

  [['v2Forecast','v2-fc'], ['v3Forecast','v3-fc'], ['v4Forecast','v4-fc']].forEach(([containerId, prefix]) => {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';
    for (let i = 1; i <= 3; i++) {
      const dt = new Date(d.time[i] + 'T12:00:00');
      const nm = i === 1 ? 'Today' : DAYS[dt.getDay()];
      const fi = wInfo(d.weather_code[i], false);
      const hi = Math.round(d.temperature_2m_max[i]);
      const lo = Math.round(d.temperature_2m_min[i]);
      const div = document.createElement('div');
      div.className = prefix + (i === 1 ? ' today' : '');

      if (prefix === 'v4-fc') {
        div.innerHTML = `<span class="v4-fc-icon">${fi.icon}</span><div class="v4-fc-info"><span class="v4-fc-name">${nm}</span><span class="v4-fc-temps">${hi}\u00B0 <span class="v4-fc-lo">${lo}\u00B0</span></span></div>`;
      } else {
        div.innerHTML = `<span class="${prefix}-name">${nm}</span><span class="${prefix}-icon">${fi.icon}</span><div class="${prefix}-temps"><span class="${prefix}-hi">${hi}\u00B0</span> <span class="${prefix}-lo">${lo}\u00B0</span></div>`;
      }
      div.addEventListener('click', () => showForecastDetail(i));
      container.appendChild(div);
    }
  });
}

// Click handlers for gauges, extras, horizon stats, grid cells
document.querySelectorAll('.gauge[data-metric], .v2-extra[data-metric], .v3-stat[data-metric], .data-cell[data-metric]').forEach(el => {
  el.addEventListener('click', () => showStatHistory(el.dataset.metric));
});

/* ===== BURN-IN PROTECTION ===== */
const LAYOUTS = ['', 'layout-mirror', 'layout-shift-dr', 'layout-shift-ul'];
let currentLayout = 0;

function rotateLayout() {
  LAYOUTS.forEach(cls => { if (cls) document.body.classList.remove(cls); });
  currentLayout = (currentLayout + 1) % LAYOUTS.length;
  const cls = LAYOUTS[currentLayout];
  if (cls) document.body.classList.add(cls);
  // Also rotate the weather view for burn-in
  if (typeof autoRotateView === 'function') autoRotateView();
}

/* ===== SCREEN SCHEDULE ===== */
let screenIsOff = false;

function checkScreenSchedule() {
  const hour = new Date().getHours();
  const shouldBeOff = (hour >= 0 && hour < 5);

  if (shouldBeOff && !screenIsOff) {
    screenIsOff = true;
    document.getElementById('screenBlackout').style.display = 'block';
    fetch('/api/display', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'off' })
    }).catch(() => {});
  } else if (!shouldBeOff && screenIsOff) {
    screenIsOff = false;
    document.getElementById('screenBlackout').style.display = 'none';
    fetch('/api/display', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'on' })
    }).catch(() => {});
  }
}

/* ===== INIT ===== */
updateClock(); setInterval(updateClock, 1000);
loadWeather(); setInterval(loadWeather, 15 * 60 * 1000);
loadLights(); setInterval(loadLights, 30000);
refreshWebcam(); setInterval(refreshWebcam, 5 * 60 * 1000);
setInterval(rotateCamSource, 60 * 60 * 1000); // rotate cam source hourly
loadSports(); setInterval(loadSports, 60 * 1000); // poll sports every 60s
setInterval(rotateLayout, 60 * 60 * 1000); // rotate layout every hour
setInterval(autoRotateView, 15 * 60 * 1000); // rotate weather view every 15 min
checkScreenSchedule(); setInterval(checkScreenSchedule, 60 * 1000); // check every minute
renderScene();
</script>
</body>
</html>
